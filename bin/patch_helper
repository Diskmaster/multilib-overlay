#!/bin/sh

# patch-update - A quick version of refreshing a patch for a specific ebuild, use me with care. .ebuild extension auto-assumed. Intentionally dumb.
# $1 should be the full atom plus the ebuild without extension. e.g. www-client/mozilla-firefox/mozilla-firefox-3.6.7
echo_red() {
	echo -e "\033[1;31m$*\033[0m"
}

echo_green() {
	echo -e "\033[1;32m$*\033[0m"
}

echo_yellow() {
	echo -e "\033[1;33m$*\033[0m"
}

# bin/auto-sync-cfg should be in .gitignore.
# No, that's invalid. Use the user's home directory (or root if you are crazy.).
if [[ -f ~/auto-sync-cfg ]]; then
	echo_green "Passed auto-sync-cfg sanity check."
	source ~/auto-sync-cfg
else
	echo_red "Failed auto-sync-cfg sanity check, copying template to user home directory."
	cp -v bin/auto-sync-cfg.skel ~/auto-sync-cfg
	exit 1	
fi

SOURCE_EBUILD=$1

if [ -z "${EDITOR}" ]; then
  EDITOR="gedit"
fi

if [ ! -n "${SOURCE_EBUILD}" ]
then
  	echo "Usage: `basename $0` category/package/package-version"
  	exit $E_BADARGS
fi  

if [ ! -e "${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild" ]
then
	if [ -e "${PORTAGE_DIR}/${SOURCE_EBUILD}" ]
	then 
		SOURCE_EBUILD=$(echo ${SOURCE_EBUILD} | sed 's/\(.*\)\.ebuild/\1/')
	else
		echo "ERROR: ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild must exist"
		exit $E_BADARGS
	fi
fi

cp ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ${SOURCE_EBUILD}.ebuild

if [ -e "./doc/patches/${SOURCE_EBUILD}.ebuild.patch" ]
then
	patch -p0 < "./doc/patches/${SOURCE_EBUILD}.ebuild.patch"
fi

if [ "${EDITOR}" == "gedit" ]; then
  echo "Using gedit"
  pkill ${EDITOR}
  ${EDITOR} ${SOURCE_EBUILD}.ebuild > /dev/null 2>&1 
else
  nano "${SOURCE_EBUILD}.ebuild"
fi

mkdir -p `dirname doc/patches/${SOURCE_EBUILD}`

diff -u ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ./${SOURCE_EBUILD}.ebuild > doc/patches/${SOURCE_EBUILD}.ebuild.patch




