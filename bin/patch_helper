#!/bin/sh

# patch-update - A quick version of refreshing a patch for a specific ebuild, use me with care. .ebuild extension auto-assumed. Intentionally dumb.
# $1 should be the full atom plus the ebuild without extension. e.g. www-client/mozilla-firefox/mozilla-firefox-3.6.7

PORTAGE_DIR="/auto/portage"
SOURCE_EBUILD=$1

if [ -z "${EDITOR}" ]; then
  EDITOR="gedit"
fi

if [ ! -n "${SOURCE_EBUILD}" ]
then
  	echo "Usage: `basename $0` category/package/package-version"
  	exit $E_BADARGS
fi  

if [ ! -e "${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild" ]
then
	if [ -e "${PORTAGE_DIR}/${SOURCE_EBUILD}" ]
	then 
		SOURCE_EBUILD=$(echo ${SOURCE_EBUILD} | sed 's/\(.*\)\.ebuild/\1/')
	else
		echo "ERROR: ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild must exist"
		exit $E_BADARGS
	fi
fi

cp ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ${SOURCE_EBUILD}.ebuild

if [ -e "./doc/patches/${SOURCE_EBUILD}.ebuild.patch" ]
then
	patch -p0 < "./doc/patches/${SOURCE_EBUILD}.ebuild.patch"
fi

if [ "${EDITOR}" == "gedit" ]; then
  echo "Using gedit"
  pkill ${EDITOR}
  ${EDITOR} ${SOURCE_EBUILD}.ebuild > /dev/null 2>&1 
else
  nano "${SOURCE_EBUILD}.ebuild"
fi

mkdir -p `dirname doc/patches/${SOURCE_EBUILD}`

diff -u ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ./${SOURCE_EBUILD}.ebuild > doc/patches/${SOURCE_EBUILD}.ebuild.patch




