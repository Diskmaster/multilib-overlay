#!/bin/sh

# patch-update - A quick version of refreshing a patch for a specific ebuild, use me with care. .ebuild extension auto-assumed. Intentionally dumb.
# $1 should be the full atom plus the ebuild without extension. e.g. www-client/mozilla-firefox/mozilla-firefox-3.6.7

# bin/auto-sync-cfg should be in .gitignore.
if [[ -f bin/auto-sync-cfg ]]; then
	echo_green "Passed auto-sync-cfg sanity check."
	source bin/auto-sync-cfg
else
	echo_red "Failed auto-sync-cfg sanity check, copying from .skel. You may wanna review it!"
	cp -v bin/auto-sync-cfg.skel bin/auto-sync-cfg
	exit 1	
fi

SOURCE_EBUILD=$1

if [ ! -n "${SOURCE_EBUILD}" ]
then
  	echo "Usage: `basename $0` category/package/package-version"
  	exit $E_BADARGS
fi  

if [ ! -e "${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild" ]
then
	if [ -e "${PORTAGE_DIR}/${SOURCE_EBUILD}" ]
	then 
		SOURCE_EBUILD=$(echo ${SOURCE_EBUILD} | sed 's/\(.*\)\.ebuild/\1/')
	else
		echo "ERROR: ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild must exist"
		exit $E_BADARGS
	fi
fi

cp ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ${SOURCE_EBUILD}.ebuild

if [ -e "./doc/patches/${SOURCE_EBUILD}.ebuild.patch" ]
then
	patch -p0 < "./doc/patches/${SOURCE_EBUILD}.ebuild.patch"
fi

pkill gedit
gedit ${SOURCE_EBUILD}.ebuild > /dev/null 2>&1 

mkdir -p `dirname doc/patches/${SOURCE_EBUILD}`

diff -u ${PORTAGE_DIR}/${SOURCE_EBUILD}.ebuild ./${SOURCE_EBUILD}.ebuild > doc/patches/${SOURCE_EBUILD}.ebuild.patch




