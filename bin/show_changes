#!/bin/bash

# The purpose of this script is to display updates to ebuilds in the portage
# tree that need to be ported over to the ebuilds in the overlay, so that you
# can bring them up to date.

# Possible future directions for this script could involve generating a diff of
# the old revision and the overlay file and trying to apply it to the new
# revision.  At the moment it is manual.

# Another obvious possibility would be scanning for changes in the portage tree
# for everything in the overlay.  This has some large problems: it is difficult
# to know when a particular file was taken out of portage, and so determine how
# far back to check for changes.  This is easy for ebuilds and eclasses, with
# their CVS headers, but for other files this is hugely problematic.

# IMPORTANT NOTE: You will need an actual CVS checkout of the portage tree,
# which you'll need to update before running this script.  You can set the
# following env var to where yours is.

: ${EMULTILIB_CVS_TREE:=~/src/gentoo-x86}

die() {
	local line
	for line in "${@:2}"
	do
		printf >&2 '%s\n' "$0: $line"
	done
	exit "$1"
}

if ! [[ "$( cat profiles/repo_name 2>/dev/null )" = multilib ]]
then
	die 1 "Please cd to your multilib overlay directory and run this" \
		"script as bin/show_changes [files]"
fi

shopt -s extglob

if (( $# != 1 )) || [[ "$1" != !(*[/.]*)/!(*[/.]*)/!(*/*).ebuild ]] && \
	[[ "$1" != eclass/!(*/*).eclass ]]
then
	die 1 "You must specify exactly one relative path to an ebuild or " \
		"eclass" 
fi

if [[ "$1" = *.eclass ]]
then
	eclass="true"
fi

file="$1"

overlay_revision="$(awk '/# \$Header: / { print $4; exit }' "$file")" || \
	die 3 "failed to pull revision from cvs header in overlay file"

pushd >/dev/null "$EMULTILIB_CVS_TREE" || \
	die 2 "pushd '$EMULTILIB_CVS_TREE' failed"

cvs diff -s -d -u -r "$overlay_revision" "$file"
(( $? == 0 )) && echo "No changes made in '$file'"

popd >/dev/null || die 2 "popd failed"

if ! [[ "$eclass" = true ]]
then
	echo "======================================================="
	diff -ur -x CVS "$EMULTILIB_CVS_TREE/${file%/*}/files/" \
		"${file%/*}/files/"
	case $? in
		0) echo "No changes made in '${file%/*}/files/'" ;;
		1) : ;;
		*) die 2 "diff failed with exit code $?" ;;
	esac
fi
